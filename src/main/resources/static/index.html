<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Flashcards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .restart-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #999;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            opacity: 0.6;
            min-width: auto;
        }

        .restart-btn:hover {
            background: #f8f9fa;
            color: #666;
            opacity: 1;
            transform: none;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 4px;
        }

        .card-container {
            position: relative;
            height: 600px;
            margin: 30px 0;
            perspective: 1000px;
        }

        .flashcard {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backface-visibility: hidden;
            padding: 20px;
            overflow-y: auto;
        }

        .rank-indicator {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.7rem;
            opacity: 0.7;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        .card-front {
            color: white;
        }

        .card-front.noun {
            background: #ff6b8a;
            color: white;
        }

        .card-front.verb {
            background: #4ecdc4;
            color: white;
        }

        .card-front.adjective {
            background: #ff9f43;
            color: white;
        }

        .card-front.adverb {
            background: #a55eea;
            color: white;
        }

        .card-front.mixed {
            background: #667eea;
            color: white;
        }

        .card-back {
            background: #f8f9fa;
            color: #2c3e50;
            transform: rotateY(180deg);
        }

        .field-group {
            margin: 6px 0;
            width: 100%;
            text-align: center;
        }

        .field-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 3px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-value {
            font-size: 1.1rem;
            font-weight: 500;
            padding: 6px 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            hyphens: auto;
            color: white;
        }

        .field-value.primary {
            font-size: 1.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.25);
            cursor: default;
            margin-bottom: 8px;
            color: white;
        }

        .field-value.blurred {
            filter: blur(10px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .field-value.blurred:hover {
            filter: blur(7px);
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .field-value.revealed {
            filter: none !important;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.6);
            animation: reveal 0.3s ease-out;
            color: white;
        }

        .field-value.empty {
            opacity: 0.5;
            font-style: italic;
            cursor: default;
        }

        @keyframes reveal {
            from {
                filter: blur(10px);
                transform: scale(0.95);
            }
            to {
                filter: none;
                transform: scale(1);
            }
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-success:hover, .btn-danger:hover {
            transform: translateY(-2px);
        }

        .btn-clear {
            background: none;
            border: none;
            color: #bbb;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 4px 10px;
            margin-top: 12px;
            min-width: auto;
            text-decoration: underline;
            text-underline-offset: 2px;
            font-weight: 400;
        }

        .btn-clear:hover {
            color: #ff416c;
            transform: none;
            background: none;
        }

        .btn-view {
            background: none;
            border: none;
            color: #bbb;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 4px 10px;
            margin-top: 12px;
            min-width: auto;
            text-decoration: underline;
            text-underline-offset: 2px;
            font-weight: 400;
        }

        .btn-view:hover {
            color: #667eea;
            transform: none;
            background: none;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .progress-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: min(95vw, 1400px);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            font-weight: 500;
            font-size: 1.3rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            min-width: auto;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
            transform: none;
            background: none;
        }

        .modal-empty {
            color: #999;
            text-align: center;
            padding: 20px 0;
            font-style: italic;
        }

        .progress-sections {
            display: flex;
            gap: 6px;
            overflow-x: auto;
        }

        .progress-section {
            flex: 1;
            min-width: 0;
        }

        .progress-row {
            padding: 3px 0;
            border-bottom: 1px solid #f5f5f5;
            font-size: 0.78rem;
        }

        .progress-row:last-child {
            border-bottom: none;
        }

        .word-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .word-cell.snoozed-soon  { color: #b71c1c; } /* < 3 days  ‚Äî dark red   */
        .word-cell.snoozed-near  { color: #92400e; } /* 3‚Äì7 days  ‚Äî dark amber */
        .word-cell.snoozed-far   { color: #2e7d32; } /* 8+ days   ‚Äî dark green */
        .word-cell.expired       { color: #ccc;    }

        .type-tag {
            color: #aaa;
            font-size: 0.7rem;
            margin-left: 2px;
        }

        .loading {
            color: #667eea;
            font-size: 1.1rem;
            margin: 20px 0;
        }

        .error {
            color: #ff416c;
            background: #fff5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ff416c;
        }

        .progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .word-type-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .word-type-selector h3, .word-type-selector h4 {
            margin-bottom: 15px;
            color: #333;
            font-weight: 500;
        }

        .type-buttons, .rank-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .type-btn, .rank-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .type-btn:hover, .rank-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .type-btn.selected, .rank-btn.selected {
            background: #667eea;
            color: white;
        }

        .rank-selector {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .controls {
                flex-wrap: wrap;
                gap: 10px;
            }

            button {
                min-width: 100px;
                padding: 10px 20px;
            }

            .type-buttons, .rank-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="restart-btn" id="restartBtn" title="Start Over">‚Ü∫</button>

        <h1>German Flashcards</h1>

        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="currentCard">-</div>
                <div class="stat-label">Current</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="totalCards">-</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="correctCount">0</div>
                <div class="stat-label">Correct</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="wordType">-</div>
                <div class="stat-label">Type</div>
            </div>
        </div>

        <div class="word-type-selector" id="wordTypeSelector">
            <h3>Choose Word Type:</h3>
            <div class="type-buttons">
                <button class="type-btn" data-type="nouns">Nouns</button>
                <button class="type-btn" data-type="verbs">Verbs</button>
                <button class="type-btn" data-type="adjectives">Adjectives</button>
                <button class="type-btn" data-type="adverbs">Adverbs</button>
                <button class="type-btn" data-type="mixed">Mixed</button>
            </div>
            <div class="rank-selector" id="rankSelector" style="display: none;">
                <h4>Select Difficulty Level:</h4>
                <div class="rank-buttons">
                    <button class="rank-btn" data-rank="1-20">Very Common (1-20)</button>
                    <button class="rank-btn" data-rank="20-45">Somewhat Common (20-45)</button>
                    <button class="rank-btn" data-rank="45-80">Less Common (45-80)</button>
                    <button class="rank-btn" data-rank="80-100">Uncommon (80-100)</button>
                    <button class="rank-btn" data-rank="all">All Words (1-100)</button>
                </div>
            </div>
            <div>
                <button class="btn-clear" id="clearProgressBtn">Clear Progress</button>
                <button class="btn-view" id="viewProgressBtn">View Progress</button>
            </div>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>

        <div id="loadingState" class="loading">Loading flashcards...</div>
        <div id="errorState" class="error" style="display: none;"></div>

        <div id="cardContainer" class="card-container" style="display: none;">
            <div class="flashcard" id="flashcard">
                <div class="card-face card-front">
                    <div class="field-group">
                        <div class="field-label">German</div>
                        <div class="field-value primary" id="germanField">Click to start</div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">English</div>
                        <div class="field-value blurred" id="englishField">Translation</div>
                    </div>
                    <div class="field-group" id="articleGroup" style="display: none;">
                        <div class="field-label">Article</div>
                        <div class="field-value blurred" id="articleField"></div>
                    </div>
                    <div class="field-group" id="pluralGroup" style="display: none;">
                        <div class="field-label">Plural</div>
                        <div class="field-value blurred" id="pluralField"></div>
                    </div>
                    <div class="field-group" id="variationsGroup" style="display: none;">
                        <div class="field-label">Variations</div>
                        <div class="field-value blurred" id="variationsField"></div>
                    </div>
                    <div class="field-group" id="partizipGroup" style="display: none;">
                        <div class="field-label">Partizip II</div>
                        <div class="field-value blurred" id="partizipField"></div>
                    </div>
                    <div class="field-group" id="hilfsvarbGroup" style="display: none;">
                        <div class="field-label">Auxiliary Verb</div>
                        <div class="field-value blurred" id="hilfsvarbField"></div>
                    </div>
                    <div class="field-group" id="presentGroup" style="display: none;">
                        <div class="field-label">Present Tense</div>
                        <div class="field-value blurred" id="presentField"></div>
                    </div>
                    <div class="field-group" id="preteritGroup" style="display: none;">
                        <div class="field-label">Preterite (ich)</div>
                        <div class="field-value blurred" id="preteritField"></div>
                    </div>
                    <div class="field-group" id="konjunktivGroup" style="display: none;">
                        <div class="field-label">Konjunktiv II (ich)</div>
                        <div class="field-value blurred" id="konjunktivField"></div>
                    </div>
                    <div class="field-group" id="imperativGroup" style="display: none;">
                        <div class="field-label">Imperative</div>
                        <div class="field-value blurred" id="imperativField"></div>
                    </div>
                    <div class="rank-indicator" id="rankIndicator">Rank: - / 100</div>
                </div>
                <div class="card-face card-back">
                    <div class="field-group">
                        <div class="field-label">Study Complete!</div>
                        <div class="field-value primary">All fields revealed</div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">Tip</div>
                        <div class="field-value">Click ‚úÖ if you got it right, ‚ùå if you need more practice</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="controls" class="controls" style="display: none;">
            <button class="btn-secondary" id="flipBtn">Reveal</button>
            <button class="btn-danger" id="incorrectBtn">‚ùå Need Practice</button>
            <button class="btn-success" id="correctBtn">‚úÖ Got It Right</button>
        </div>

        <div id="startControls" class="controls" style="display: none;">
            <button class="btn-primary" id="startBtn">Start Learning</button>
            <button class="btn-secondary" id="refreshBtn">Change Settings</button>
        </div>
    </div>

    <div id="progressModal" class="modal-overlay" style="display: none;">
        <div class="progress-modal">
            <div class="modal-header">
                <h3>Saved Progress</h3>
                <button class="modal-close" id="progressModalClose">√ó</button>
            </div>
            <div id="progressModalContent" class="modal-body"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'stressig_learned';
        const SNOOZE_SHORT_DAYS = 7;
        const SNOOZE_LONG_DAYS = 31;

        class FlashcardApp {
            constructor() {
                this.words = [];
                this.currentIndex = 0;
                this.correctAnswers = 0;
                this.isFlipped = false;
                this.selectedWordType = null;
                this.selectedRank = null;

                this.initializeElements();
                this.attachEventListeners();
                this.showWordTypeSelector();
            }

            initializeElements() {
                this.elements = {
                    loadingState: document.getElementById('loadingState'),
                    errorState: document.getElementById('errorState'),
                    cardContainer: document.getElementById('cardContainer'),
                    controls: document.getElementById('controls'),
                    startControls: document.getElementById('startControls'),
                    wordTypeSelector: document.getElementById('wordTypeSelector'),
                    rankSelector: document.getElementById('rankSelector'),
                    flashcard: document.getElementById('flashcard'),
                    currentCard: document.getElementById('currentCard'),
                    totalCards: document.getElementById('totalCards'),
                    correctCount: document.getElementById('correctCount'),
                    wordType: document.getElementById('wordType'),
                    progressBar: document.getElementById('progressBar'),
                    flipBtn: document.getElementById('flipBtn'),
                    correctBtn: document.getElementById('correctBtn'),
                    incorrectBtn: document.getElementById('incorrectBtn'),
                    startBtn: document.getElementById('startBtn'),
                    refreshBtn: document.getElementById('refreshBtn'),
                    restartBtn: document.getElementById('restartBtn'),
                    clearProgressBtn: document.getElementById('clearProgressBtn'),
                    viewProgressBtn: document.getElementById('viewProgressBtn'),
                    progressModal: document.getElementById('progressModal'),
                    progressModalClose: document.getElementById('progressModalClose'),
                    progressModalContent: document.getElementById('progressModalContent'),

                    germanField: document.getElementById('germanField'),
                    englishField: document.getElementById('englishField'),
                    articleField: document.getElementById('articleField'),
                    pluralField: document.getElementById('pluralField'),
                    variationsField: document.getElementById('variationsField'),
                    partizipField: document.getElementById('partizipField'),
                    hilfsvarbField: document.getElementById('hilfsvarbField'),
                    presentField: document.getElementById('presentField'),
                    preteritField: document.getElementById('preteritField'),
                    konjunktivField: document.getElementById('konjunktivField'),
                    imperativField: document.getElementById('imperativField'),
                    rankIndicator: document.getElementById('rankIndicator'),

                    articleGroup: document.getElementById('articleGroup'),
                    pluralGroup: document.getElementById('pluralGroup'),
                    variationsGroup: document.getElementById('variationsGroup'),
                    partizipGroup: document.getElementById('partizipGroup'),
                    hilfsvarbGroup: document.getElementById('hilfsvarbGroup'),
                    presentGroup: document.getElementById('presentGroup'),
                    preteritGroup: document.getElementById('preteritGroup'),
                    konjunktivGroup: document.getElementById('konjunktivGroup'),
                    imperativGroup: document.getElementById('imperativGroup')
                };
            }

            attachEventListeners() {
                this.elements.flipBtn.addEventListener('click', () => this.revealAllFields());
                this.elements.correctBtn.addEventListener('click', () => this.markCorrect());
                this.elements.incorrectBtn.addEventListener('click', () => this.markIncorrect());
                this.elements.startBtn.addEventListener('click', () => this.startLearning());
                this.elements.refreshBtn.addEventListener('click', () => this.showWordTypeSelector());
                this.elements.restartBtn.addEventListener('click', () => this.showWordTypeSelector());
                this.elements.clearProgressBtn.addEventListener('click', () => this.clearProgress());
                this.elements.viewProgressBtn.addEventListener('click', () => this.showProgress());
                this.elements.progressModalClose.addEventListener('click', () => this.closeProgress());
                this.elements.progressModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.progressModal) this.closeProgress();
                });

                this.setupFieldClickListeners();

                document.querySelectorAll('.type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        this.selectedWordType = e.target.dataset.type;
                        this.elements.rankSelector.style.display = 'block';
                    });
                });

                document.querySelectorAll('.rank-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('selected'));
                        e.target.classList.add('selected');
                        this.selectedRank = e.target.dataset.rank;
                        this.loadWords();
                    });
                });

                document.addEventListener('keydown', (e) => {
                    if (this.words.length === 0 || this.elements.wordTypeSelector.style.display !== 'none') return;

                    switch(e.key) {
                        case ' ':
                        case 'Enter':
                            e.preventDefault();
                            this.revealAllFields();
                            break;
                        case 'c':
                            e.preventDefault();
                            this.markCorrect();
                            break;
                        case 'x':
                            e.preventDefault();
                            this.markIncorrect();
                            break;
                    }
                });
            }

            setupFieldClickListeners() {
                const clickableFields = [
                    'englishField', 'articleField', 'pluralField', 'variationsField',
                    'partizipField', 'hilfsvarbField', 'presentField',
                    'preteritField', 'konjunktivField', 'imperativField'
                ];

                clickableFields.forEach(fieldId => {
                    const element = this.elements[fieldId];
                    if (element) {
                        element.addEventListener('click', () => this.revealField(element));
                    }
                });
            }

            revealField(fieldElement) {
                if (fieldElement.classList.contains('blurred')) {
                    fieldElement.classList.remove('blurred');
                    fieldElement.classList.add('revealed');
                }
            }

            revealAllFields() {
                const blurredFields = document.querySelectorAll('.field-value.blurred');
                blurredFields.forEach(field => {
                    field.classList.remove('blurred');
                    field.classList.add('revealed');
                });
            }

            // --- LocalStorage helpers ---

            getLearnedWords() {
                try {
                    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                } catch (e) {
                    return {};
                }
            }

            wordKey(word) {
                return `${word.type}:${word.id}`;
            }

            isWordSnoozed(word) {
                const learned = this.getLearnedWords();
                const entry = learned[this.wordKey(word)];
                if (!entry) return false;
                return Date.now() < entry.timestamp + entry.days * 24 * 60 * 60 * 1000;
            }

            saveLearnedWord(word) {
                const learned = this.getLearnedWords();
                const key = this.wordKey(word);
                // If an entry already exists (even expired), escalate to 31 days
                const days = learned[key] ? SNOOZE_LONG_DAYS : SNOOZE_SHORT_DAYS;
                const text = word.root || word.de || `${word.type} #${word.id}`;
                learned[key] = { timestamp: Date.now(), days, text };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(learned));
            }

            clearProgress() {
                localStorage.removeItem(STORAGE_KEY);
                this.elements.clearProgressBtn.textContent = 'Cleared!';
                setTimeout(() => {
                    this.elements.clearProgressBtn.textContent = 'Clear Progress';
                }, 1500);
            }

            showProgress() {
                const learned = this.getLearnedWords();
                const keys = Object.keys(learned);

                if (keys.length === 0) {
                    this.elements.progressModalContent.innerHTML =
                        '<p class="modal-empty">No progress saved yet.</p>';
                } else {
                    const now = Date.now();

                    const typeAbbrev = { noun: 'n', verb: 'v', adverb: 'adv', adjective: 'adj' };

                    const rows = keys.map(key => {
                        const [type, id] = key.split(':');
                        const entry = learned[key];
                        const snoozeUntil = entry.timestamp + entry.days * 24 * 60 * 60 * 1000;
                        const isActive = now < snoozeUntil;
                        const daysLeft = isActive
                            ? Math.ceil((snoozeUntil - now) / (24 * 60 * 60 * 1000))
                            : 0;
                        const text = entry.text ||
                            (type.charAt(0).toUpperCase() + type.slice(1)) + ' #' + id;
                        const abbrev = typeAbbrev[type] || type;
                        return { text, abbrev, isActive, daysLeft };
                    });

                    rows.sort((a, b) => {
                        if (a.isActive !== b.isActive) return a.isActive ? -1 : 1;
                        return b.daysLeft - a.daysLeft;
                    });

                    const activeCount = rows.filter(r => r.isActive).length;
                    const summary = `<p style="margin-bottom:16px; color:#666; font-size:0.9rem;">
                        ${activeCount} word${activeCount !== 1 ? 's' : ''} currently snoozed
                        &nbsp;¬∑&nbsp; ${rows.length - activeCount} expired
                    </p>`;

                    const NUM_SECTIONS = 10;
                    const sections = Array.from({ length: NUM_SECTIONS }, () => []);
                    rows.forEach((row, i) => sections[i % NUM_SECTIONS].push(row));

                    const sectionsHtml = sections.map(sectionRows => {
                        const colorClass = r => {
                            if (!r.isActive) return 'expired';
                            if (r.daysLeft < 3) return 'snoozed-soon';
                            if (r.daysLeft < 8) return 'snoozed-near';
                            return 'snoozed-far';
                        };
                        const rowsHtml = sectionRows.map(r => `
                            <div class="progress-row">
                                <span class="word-cell ${colorClass(r)}">${r.text}<span class="type-tag">(${r.abbrev})</span></span>
                            </div>`).join('');
                        return `<div class="progress-section">${rowsHtml}</div>`;
                    }).join('');

                    this.elements.progressModalContent.innerHTML =
                        summary + `<div class="progress-sections">${sectionsHtml}</div>`;
                }

                this.elements.progressModal.style.display = 'flex';
            }

            closeProgress() {
                this.elements.progressModal.style.display = 'none';
            }

            // ---

            showWordTypeSelector() {
                this.elements.loadingState.style.display = 'none';
                this.elements.errorState.style.display = 'none';
                this.elements.cardContainer.style.display = 'none';
                this.elements.controls.style.display = 'none';
                this.elements.startControls.style.display = 'none';
                this.elements.wordTypeSelector.style.display = 'block';
                this.elements.rankSelector.style.display = 'none';

                // Hide stats on settings screen
                document.querySelector('.stats').style.display = 'none';
                document.querySelector('.progress').style.display = 'none';

                document.querySelectorAll('.type-btn, .rank-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            }

            async loadWords() {
                this.showLoading();
                try {
                    let allWords = [];

                    if (this.selectedWordType === 'mixed') {
                        const endpoints = ['nouns', 'verbs', 'adjectives', 'adverbs'];
                        const promises = endpoints.map(endpoint =>
                            this.fetchWordsFromEndpoint(endpoint)
                                .then(words => words.map(word => ({...word, type: endpoint.slice(0, -1)})))
                                .catch(error => {
                                    console.warn(`Failed to load ${endpoint}:`, error);
                                    return [];
                                })
                        );

                        const results = await Promise.all(promises);
                        allWords = results.flat();
                    } else {
                        const words = await this.fetchWordsFromEndpoint(this.selectedWordType);
                        allWords = words.map(word => ({...word, type: this.selectedWordType.slice(0, -1)}));
                    }

                    // Filter out words that are currently snoozed
                    allWords = allWords.filter(word => !this.isWordSnoozed(word));

                    if (allWords.length === 0) {
                        throw new Error('No words to study ‚Äî all words are snoozed. Come back later or clear your progress.');
                    }

                    this.words = allWords;
                    this.shuffleArray(this.words);
                    this.showStartScreen();

                } catch (error) {
                    console.error('Error loading words:', error);
                    this.showError(error.message);
                }
            }

            async fetchWordsFromEndpoint(endpoint) {
                const baseUrl = `/api/${endpoint}`;
                let url = baseUrl;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${endpoint}`);
                }

                const data = await response.json();

                // Filter by rank range if not 'all'
                if (this.selectedRank !== 'all') {
                    const [minRank, maxRank] = this.selectedRank.split('-').map(Number);
                    return data.filter(word => word.rank && word.rank >= minRank && word.rank <= maxRank);
                }

                return data;
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            showLoading() {
                this.elements.loadingState.style.display = 'block';
                this.elements.errorState.style.display = 'none';
                this.elements.cardContainer.style.display = 'none';
                this.elements.controls.style.display = 'none';
                this.elements.startControls.style.display = 'none';
                this.elements.wordTypeSelector.style.display = 'none';
            }

            showError(message) {
                this.elements.loadingState.style.display = 'none';
                this.elements.errorState.style.display = 'block';
                this.elements.errorState.textContent = message;
                this.elements.cardContainer.style.display = 'none';
                this.elements.controls.style.display = 'none';
                this.elements.startControls.style.display = 'none';
                this.elements.wordTypeSelector.style.display = 'block';
            }

            showStartScreen() {
                this.elements.loadingState.style.display = 'none';
                this.elements.errorState.style.display = 'none';
                this.elements.cardContainer.style.display = 'none';
                this.elements.controls.style.display = 'none';
                this.elements.startControls.style.display = 'flex';
                this.elements.wordTypeSelector.style.display = 'none';

                // Show stats after word loading
                document.querySelector('.stats').style.display = 'flex';
                document.querySelector('.progress').style.display = 'block';

                this.elements.totalCards.textContent = this.words.length;
                this.elements.wordType.textContent = this.selectedWordType.charAt(0).toUpperCase() + this.selectedWordType.slice(1);

                this.updateProgress();
            }

            startLearning() {
                this.currentIndex = 0;
                this.correctAnswers = 0;
                this.isFlipped = false;

                this.elements.cardContainer.style.display = 'block';
                this.displayCurrentCard();

                this.elements.startControls.style.display = 'none';
                this.elements.controls.style.display = 'flex';
                this.updateStats();
            }

            displayCurrentCard() {
                if (this.currentIndex >= this.words.length) {
                    this.showComplete();
                    return;
                }

                const word = this.words[this.currentIndex];

                this.resetFieldStates();
                this.setCardColor(word.type);

                const germanWord = word.root || word.de || 'No German word';
                this.elements.germanField.textContent = germanWord;
                this.elements.germanField.classList.remove('blurred');

                this.elements.englishField.textContent = word.en || 'No translation';

                // Update rank indicator
                const rank = word.rank || '-';
                this.elements.rankIndicator.textContent = `Rank: ${rank} / 100`;

                this.hideAllConditionalGroups();

                if (word.type === 'noun') {
                    this.showNounFields(word);
                } else if (word.type === 'verb') {
                    this.showVerbFields(word);
                } else if (word.type === 'adjective' || word.type === 'adverb') {
                    this.showAdjectiveAdverbFields(word);
                }

                this.elements.flashcard.classList.remove('flipped');
                this.isFlipped = false;

                this.updateStats();
                this.updateProgress();
            }

            setCardColor(wordType) {
                const cardFront = this.elements.flashcard.querySelector('.card-front');
                cardFront.classList.remove('noun', 'verb', 'adjective', 'adverb', 'mixed');
                cardFront.classList.add(wordType);
            }

            hideAllConditionalGroups() {
                const conditionalGroups = [
                    'articleGroup', 'pluralGroup', 'variationsGroup', 'partizipGroup',
                    'hilfsvarbGroup', 'presentGroup', 'preteritGroup',
                    'konjunktivGroup', 'imperativGroup'
                ];

                conditionalGroups.forEach(groupId => {
                    const element = this.elements[groupId];
                    if (element && element.style) {
                        element.style.display = 'none';
                    }
                });
            }

            resetFieldStates() {
                const allFields = document.querySelectorAll('.field-value:not(.primary)');
                allFields.forEach(field => {
                    field.classList.remove('revealed');
                    field.classList.add('blurred');
                    field.classList.remove('empty');
                });
            }

            showNounFields(word) {
                if (word.article && this.elements.articleGroup) {
                    this.elements.articleGroup.style.display = 'block';
                    this.elements.articleField.textContent = word.article;
                }

                if (word.plural && this.elements.pluralGroup) {
                    this.elements.pluralGroup.style.display = 'block';
                    this.elements.pluralField.textContent = word.plural;
                }
            }

            showAdjectiveAdverbFields(word) {
                if (word.variations && this.elements.variationsGroup) {
                    this.elements.variationsGroup.style.display = 'block';
                    this.elements.variationsField.textContent = word.variations;
                }
            }

            showVerbFields(word) {
                if (word.partizipII && this.elements.partizipGroup) {
                    this.elements.partizipGroup.style.display = 'block';
                    this.elements.partizipField.textContent = word.partizipII;
                }

                if (word.hilfsverb && this.elements.hilfsvarbGroup) {
                    this.elements.hilfsvarbGroup.style.display = 'block';
                    this.elements.hilfsvarbField.textContent = word.hilfsverb;
                }

                const presentTenses = [];
                if (word.praesensIch) presentTenses.push(`ich ${word.praesensIch}`);
                if (word.praesensDu) presentTenses.push(`du ${word.praesensDu}`);
                if (word.praesensErSieEs) presentTenses.push(`er/sie/es ${word.praesensErSieEs}`);

                if (presentTenses.length > 0 && this.elements.presentGroup) {
                    this.elements.presentGroup.style.display = 'block';
                    this.elements.presentField.textContent = presentTenses.join(', ');
                }

                if (word.praeteritumIch && this.elements.preteritGroup) {
                    this.elements.preteritGroup.style.display = 'block';
                    this.elements.preteritField.textContent = word.praeteritumIch;
                }

                if (word.konjunktivIIIch && this.elements.konjunktivGroup) {
                    this.elements.konjunktivGroup.style.display = 'block';
                    this.elements.konjunktivField.textContent = word.konjunktivIIIch;
                }

                const imperatives = [];
                if (word.imperativSingular) imperatives.push(`(du) ${word.imperativSingular}`);
                if (word.imperativPlural) imperatives.push(`(ihr) ${word.imperativPlural}`);

                if (imperatives.length > 0 && this.elements.imperativGroup) {
                    this.elements.imperativGroup.style.display = 'block';
                    this.elements.imperativField.textContent = imperatives.join(', ');
                }
            }

            markCorrect() {
                this.correctAnswers++;
                const word = this.words[this.currentIndex];
                this.saveLearnedWord(word);
                this.nextCard();
            }

            markIncorrect() {
                this.nextCard();
            }

            nextCard() {
                this.currentIndex++;
                this.displayCurrentCard();
            }

            updateStats() {
                this.elements.currentCard.textContent = Math.min(this.currentIndex + 1, this.words.length);
                this.elements.totalCards.textContent = this.words.length;
                this.elements.correctCount.textContent = this.correctAnswers;
                this.elements.wordType.textContent = this.selectedWordType.charAt(0).toUpperCase() + this.selectedWordType.slice(1);
            }

            updateProgress() {
                const progress = this.words.length > 0 ? (this.currentIndex / this.words.length) * 100 : 0;
                this.elements.progressBar.style.width = `${progress}%`;
            }

            showComplete() {
                const accuracy = this.words.length > 0 ? Math.round((this.correctAnswers / this.words.length) * 100) : 0;
                this.elements.germanField.textContent = 'Complete! üéâ';
                this.elements.englishField.textContent = `${accuracy}% accuracy (${this.correctAnswers}/${this.words.length})`;
                this.elements.englishField.classList.remove('blurred');

                this.hideAllConditionalGroups();

                this.elements.controls.style.display = 'none';
                this.elements.startControls.style.display = 'flex';
                this.elements.startBtn.textContent = 'Start Again';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new FlashcardApp();
        });
    </script>
</body>
</html>
